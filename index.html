<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AirBand XR – Manos + Cara → Música en tiempo real</title>
<style>
  :root{ --bg:#0b0f14; --panel:#121923; --ink:#e6f0ff; --muted:#91a0b4;
         --acc:#5dd6ff; --ok:#44d19f; --warn:#ffc857; --err:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#0f1520 40%,#0b0f14);
       color:var(--ink);font:500 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  header{position:sticky;top:0;background:rgba(15,21,32,.8);backdrop-filter:blur(8px);
         border-bottom:1px solid #1e2a3a;z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px;display:grid;gap:12px}
  .controls{display:grid;gap:10px;grid-template-columns:repeat(12,1fr);align-items:center}
  .brand{grid-column:span 3;display:flex;gap:10px;align-items:center}
  .brand b{font-size:18px}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;
       background:linear-gradient(180deg,#20a4f3,#1282d6);color:white;cursor:pointer}
  .btn.secondary{background:linear-gradient(180deg,#4a5568,#2d3748)}
  .btn[disabled]{opacity:.4;cursor:not-allowed}
  .select,.range{background:var(--panel);border:1px solid #1e2a3a;color:var(--ink);border-radius:12px;padding:8px 10px}
  .range{padding:6px 10px}
  .row{display:flex;gap:10px;align-items:center}
  .tag{font-size:12px;color:var(--muted)}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;max-width:1200px;margin:14px auto;padding:0 16px}
  .stage{position:relative;border-radius:16px;overflow:hidden;border:1px solid #1e2a3a;background:#0a0f16}
  video,canvas{display:block;width:100%;height:auto}
  canvas{position:absolute;inset:0}
  .hud{position:absolute;left:12px;bottom:12px;display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#0e1522;border:1px solid #1e2a3a;color:#cfe2ff;font-size:12px}
  .panel{background:var(--panel);border:1px solid #1e2a3a;border-radius:16px;padding:12px}
  h3{margin:6px 0 10px 0;font-size:14px;color:#cfe2ff;text-transform:uppercase;letter-spacing:.1em}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .small{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0d1626;border:1px solid #1e2a3a;padding:2px 6px;border-radius:6px;color:#d6e9ff}
  footer{color:#9db0c8;text-align:center;font-size:12px;margin:20px 0 40px}
  .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .err{background:var(--err)} .warn{background:var(--warn)}
</style>
</head>
<body>
<header>
  <div class="wrap controls">
    <div class="brand">
      <span class="status-dot warn" id="camStatus"></span>
      <b>AirBand XR</b>
      <span class="tag">Webcam → Gestos → Sonido en tiempo real</span>
    </div>

    <div class="row" style="grid-column: span 3; gap:8px">
      <button id="startBtn" class="btn">Iniciar cámara & audio</button>
      <button id="stopBtn" class="btn secondary" disabled>Detener</button>
      <button id="muteBtn" class="btn secondary">Silencio</button>
    </div>

    <div class="row" style="grid-column: span 3">
      <label class="tag">Instrumento mano izquierda</label>
      <select id="leftInstrument" class="select">
        <option>Sintetizador</option><option>Piano</option><option>Guitarra</option>
        <option>Violín</option><option>Brass</option><option>Órgano</option>
      </select>
    </div>
    <div class="row" style="grid-column: span 3">
      <label class="tag">Instrumento mano derecha</label>
      <select id="rightInstrument" class="select">
        <option>Sintetizador</option><option>Piano</option><option>Guitarra</option>
        <option>Violín</option><option>Brass</option><option>Órgano</option>
      </select>
    </div>
    <div class="row" style="grid-column: span 3">
      <label class="tag">Escala</label>
      <select id="scaleRoot" class="select">
        <option value="C4">Do (C4)</option><option value="D4">Re (D4)</option>
        <option value="E4">Mi (E4)</option><option value="F4">Fa (F4)</option>
        <option value="G3">Sol (G3)</option><option value="A3">La (A3)</option>
        <option value="B3">Si (B3)</option>
      </select>
      <select id="scaleType" class="select">
        <option value="major">Mayor</option>
        <option value="minor">Menor</option>
        <option value="pentatonic">Pentatónica</option>
        <option value="blues">Blues</option>
      </select>
    </div>
    <div class="row" style="grid-column: span 3">
      <label class="tag">Volumen</label>
      <input id="volume" class="range" type="range" min="0" max="1" step="0.01" value="0.8" />
      <label class="tag">Latencia</label>
      <select id="perfMode" class="select">
        <option value="balanced">Balanceada</option>
        <option value="speed">Máxima velocidad</option>
        <option value="quality">Máxima precisión</option>
      </select>
    </div>
  </div>
</header>

<main>
  <section class="stage">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div class="hud" id="hud"></div>
  </section>

  <section class="panel">
    <h3>Gestos → Sonidos</h3>
    <div class="grid">
      <div>
        <p class="small"><b>Dedos (por mano):</b> cada dedo activa un grado de la escala. Movimiento vertical del dedo = ±12 semitonos. Mano cerrada = silencio.</p>
        <p class="small"><b>Muñeca:</b> altura modula volumen.</p>
      </div>
      <div>
        <p class="small"><b>Cara (percusión):</b> parpadeos/guiños/boca/lengua → bombo/hi-hats/caja/crash.</p>
      </div>
    </div>
  </section>
</main>

<footer>
  Requiere HTTPS o http://localhost para usar la cámara. Si lo abriste como <code>file://</code>, no funcionará.
</footer>

<script type="module">
import { FilesetResolver, HandLandmarker, FaceLandmarker, DrawingUtils }
  from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

/* Modelos oficiales */
const HAND_MODEL_URL = "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/latest/hand_landmarker.task";
const FACE_MODEL_URL = "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";

/* UI */
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const muteBtn  = document.getElementById('muteBtn');
const camStatus= document.getElementById('camStatus');
const webcamEl = document.getElementById('webcam');
const canvas   = document.getElementById('overlay');
const ctx      = canvas.getContext('2d');
const hud      = document.getElementById('hud');

const leftInstrument  = document.getElementById('leftInstrument');
const rightInstrument = document.getElementById('rightInstrument');
const scaleRoot = document.getElementById('scaleRoot');
const scaleType = document.getElementById('scaleType');
const volume = document.getElementById('volume');
const perfMode = document.getElementById('perfMode');

/* Audio */
const AudioEngine = (() => {
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC({ latencyHint: 'interactive' });
  const master = ctx.createGain(); master.gain.value = 0.8; master.connect(ctx.destination);
  const limiter = ctx.createDynamicsCompressor();
  limiter.threshold.value=-8; limiter.knee.value=14; limiter.ratio.value=12; limiter.attack.value=0.002; limiter.release.value=0.09;
  limiter.connect(master);

  const noteFreq = (note)=>{
    const A4=440, map={C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};
    const m=note.match(/^([A-G]#?|Bb|Db|Gb)(\d)$/); const n=map[m[1]]; const o=+m[2];
    return A4*Math.pow(2,(n-9+(o-4)*12)/12);
  };
  const buildScale=(root="C4",type="major")=>{
    const iv={major:[0,2,4,5,7,9,11,12],minor:[0,2,3,5,7,8,10,12],pentatonic:[0,2,4,7,9,12],blues:[0,3,5,6,7,10,12]}[type]||[0,2,4,5,7,9,11,12];
    const baseTable={'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11,'Bb':10,'Db':1,'Gb':6,'Ab':8,'Eb':3};
    const mm=root.match(/^([A-G]#?|Bb|Db|Gb)(\d)$/); const base=baseTable[mm[1]]; const octave=+mm[2];
    const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    return iv.map(semi=>{const total=base+semi+octave*12; return `${names[(total%12+12)%12]}${Math.floor(total/12)}`;});
  };
  const createVoice=(type="Sintetizador",dest=limiter)=>{
    const o={};
    o.gain=ctx.createGain(); o.gain.gain.value=0; o.gain.connect(dest);
    o.filter=ctx.createBiquadFilter(); o.filter.type='lowpass'; o.filter.frequency.value=12000; o.filter.Q.value=0.7; o.filter.connect(o.gain);
    o.osc=ctx.createOscillator(); o.osc2=ctx.createOscillator(); o.osc.type='sawtooth'; o.osc2.type='square'; o.osc.frequency.value=220; o.osc2.frequency.value=
