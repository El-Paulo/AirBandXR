<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AirBand XR ‚Äì Manos + Cara ‚Üí M√∫sica en tiempo real</title>
<style>
  :root{
    --fs: 15px; --radius: 16px; --border: #1e2a3a;
    --bg:#0b0f14; --bg2:#0f1520; --panel:#121923; --ink:#e6f0ff; --muted:#91a0b4;
    --acc:#5dd6ff; --ok:#44d19f; --warn:#ffc857; --err:#ff6b6b; --chip:#0e1522;
  }
  [data-theme="light"]{
    --bg:#f6f8fb; --bg2:#ffffff; --panel:#ffffff; --border:#d9e1ee;
    --ink:#101623; --muted:#5a6678; --acc:#007aff; --chip:#eef3fb;
  }
  @media (prefers-color-scheme: light){
    [data-theme="system"]{
      --bg:#f6f8fb; --bg2:#ffffff; --panel:#ffffff; --border:#d9e1ee;
      --ink:#101623; --muted:#5a6678; --acc:#007aff; --chip:#eef3fb;
    }
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg), var(--bg2) 40%, var(--bg));
    color:var(--ink); font:500 var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }

  header{position:sticky;top:0;background:color-mix(in oklab, var(--panel) 80%, transparent);
         backdrop-filter:blur(8px); border-bottom:1px solid var(--border); z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px;display:grid;gap:12px}
  .controls{display:grid;gap:10px;grid-template-columns:repeat(12,1fr);align-items:center}
  .brand{grid-column:span 3;display:flex;gap:10px;align-items:center}
  .brand b{font-size:calc(var(--fs) + 3px)}
  header.compact .controls .row.advanced{display:none}
  header.compact .brand .tag{display:none}
  .compact-btn{margin-left:8px}

  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;
       background:linear-gradient(180deg,#20a4f3,#1282d6);color:white;cursor:pointer}
  .btn.secondary{background:linear-gradient(180deg,#4a5568,#2d3748)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
  .btn[disabled]{opacity:.4;cursor:not-allowed}
  .select,.range{background:var(--panel);border:1px solid var(--border);color:var(--ink);border-radius:12px;padding:8px 10px}
  .range{padding:6px 10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .tag{font-size:12px;color:var(--muted)}
  .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .err{background:var(--err)} .warn{background:var(--warn)}
  .hint{color:var(--warn);font-size:12px}

  main{display:grid;grid-template-columns:1.35fr .65fr;gap:14px;max-width:1200px;margin:14px auto;padding:0 16px}
  .stage{position:relative;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);
         background:#000;resize: both; min-height:420px; width:100%; height:520px}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  canvas{position:absolute;display:block}

  .hud{position:absolute;left:12px;bottom:12px;display:flex;gap:8px;flex-wrap:wrap;z-index:2}
  .pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);
        color:color-mix(in oklab, var(--ink) 90%, transparent); font-size:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
  h3{margin:6px 0 10px 0;font-size:calc(var(--fs) - 1px);color:color-mix(in oklab, var(--ink) 85%, #cfe2ff);
     text-transform:uppercase;letter-spacing:.1em}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .small{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--chip);
       border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  footer{color:color-mix(in oklab, var(--muted) 85%, transparent);text-align:center;font-size:12px;margin:20px 0 40px}
  details{border:1px dashed color-mix(in oklab, var(--border) 80%, transparent);border-radius:12px;padding:8px}
  summary{cursor:pointer}
  @media (max-width: 960px){ main{grid-template-columns:1fr} .brand{grid-column:span 6} }
</style>
</head>
<body data-theme="system">
<header>
  <div class="wrap controls">
    <div class="brand">
      <span class="status-dot warn" id="camStatus"></span>
      <b>AirBand XR</b>
      <span class="tag">Webcam ‚Üí Gestos ‚Üí Sonido en tiempo real</span>
      <button id="compactBtn" class="btn ghost compact-btn" title="Contraer/expandir barra">Compactar barra</button>
    </div>

    <div class="row" style="grid-column: span 6">
      <button id="startBtn" class="btn">Iniciar c√°mara & audio</button>
      <button id="stopBtn" class="btn secondary" disabled>Detener</button>
      <button id="muteBtn" class="btn secondary">Silencio</button>
      <button id="recBtn" class="btn ghost" disabled>‚óè Grabar</button>
      <button id="recStopBtn" class="btn ghost" disabled>‚ñ† Detener grabaci√≥n</button>
      <span class="tag" id="recTimer">00:00</span>
      <a id="recDownload" class="tag" href="#" download="airband.webm" style="display:none">Descargar üéß</a>
      <span class="hint" id="envHint"></span>
    </div>

    <div class="row advanced" style="grid-column: span 6">
      <label class="tag" for="themeSel">Tema</label>
      <select id="themeSel" class="select" title="Tema"><option value="system">Sistema</option><option value="dark">Oscuro</option><option value="light">Claro</option></select>
      <label class="tag" for="fontSize">Tama√±o de letra</label>
      <input id="fontSize" class="range" type="range" min="80" max="130" value="100" title="Tama√±o de letra" />
      <span class="tag" id="fontVal">100%</span>
      <label class="tag" for="stageSize">Tama√±o del escenario</label>
      <input id="stageSize" class="range" type="range" min="60" max="140" value="100" title="Tama√±o del escenario" />
      <span class="tag" id="stageVal">100%</span>
      <label class="tag" for="realism">Realismo+</label>
      <select id="realism" class="select" title="Reverberaci√≥n"><option value="0">Off</option><option value="1">On</option></select>
    </div>

    <div class="row" style="grid-column: span 6">
      <label class="tag" for="leftInstrument">Instrumento mano izquierda</label>
      <select id="leftInstrument" class="select" title="Instrumento izquierdo"></select>
      <label class="tag" for="rightInstrument">Instrumento mano derecha</label>
      <select id="rightInstrument" class="select" title="Instrumento derecho"></select>
      <label class="tag" for="soundSetSel">Banco</label>
      <select id="soundSetSel" class="select" title="Banco de sonidos">
        <option value="electronico">Electr√≥nico</option>
        <option value="regional">Regional</option>
      </select>
    </div>

    <div class="row advanced" style="grid-column: span 6">
      <label class="tag" for="scaleRoot">Escala</label>
      <select id="scaleRoot" class="select" title="T√≥nica">
        <option value="C4">Do (C4)</option><option value="D4">Re (D4)</option>
        <option value="E4">Mi (E4)</option><option value="F4">Fa (F4)</option>
        <option value="G3">Sol (G3)</option><option value="A3">La (A3)</option>
        <option value="B3">Si (B3)</option>
      </select>
      <select id="scaleType" class="select" title="Modo">
        <option value="major">Mayor</option>
        <option value="minor">Menor</option>
        <option value="pentatonic">Pentat√≥nica</option>
        <option value="blues">Blues</option>
      </select>
      <label class="tag" for="perfMode">Latencia</label>
      <select id="perfMode" class="select" title="Rendimiento">
        <option value="balanced">Balanceada</option>
        <option value="speed">M√°xima velocidad</option>
        <option value="quality">M√°xima precisi√≥n</option>
      </select>
      <label class="tag" for="mirror">Espejo</label>
      <select id="mirror" class="select" title="Espejo"><option value="1">S√≠</option><option value="0">No</option></select>
      <label class="tag" for="draw">Landmarks</label>
      <select id="draw" class="select" title="Dibujar landmarks"><option value="1">S√≠</option><option value="0">No</option></select>
      <label class="tag" for="volume">Volumen</label>
      <input id="volume" class="range" type="range" min="0" max="1" step="0.01" value="0.85" title="Volumen" />
    </div>
  </div>
</header>

<main>
  <section class="stage" id="stage">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="overlay" style="left:0;top:0"></canvas>
    <div class="hud" id="hud"></div>
  </section>

  <section class="panel">
    <h3>Gestos ‚Üí Sonidos</h3>
    <div class="grid">
      <div>
        <p class="small"><b>Dedos (por mano):</b> cada dedo activa un grado de la escala. Movimiento vertical del dedo = ¬±12 semitonos. Mano cerrada = silencio.</p>
        <p class="small"><b>Mu√±eca:</b> altura modula volumen.</p>
      </div>
      <div>
        <p class="small"><b>Cara (percusi√≥n):</b></p>
        <ul class="small">
          <li><span class="kbd">Parpadeo ambos</span> ‚Üí Bombo</li>
          <li><span class="kbd">Gui√±o izq</span> ‚Üí Hi-hat cerrado</li>
          <li><span class="kbd">Gui√±o der</span> ‚Üí Hi-hat abierto</li>
          <li><span class="kbd">Boca abierta</span> ‚Üí Caja</li>
          <!-- Lengua removida -->
        </ul>
      </div>
    </div>
  </section>
</main>

<footer>
  Hecho con MediaPipe Tasks (Hands & Face Landmarker) + WebAudio. Todo corre local en tu navegador.
</footer>

<script type="module">
/* =========================
   MediaPipe (import oficial)
   ========================= */
import { FilesetResolver, HandLandmarker, FaceLandmarker, DrawingUtils }
  from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

/* Modelos oficiales */
const HAND_MODEL_URL = "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/latest/hand_landmarker.task";
const FACE_MODEL_URL = "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";

/* Entorno seguro */
const envHint = document.getElementById('envHint');
if (!location.protocol.startsWith('https') && location.hostname !== 'localhost') {
  envHint.textContent = "Abre en HTTPS o localhost para usar la c√°mara.";
}

/* ====== UI refs ====== */
const themeSel = document.getElementById('themeSel');
const fontSize = document.getElementById('fontSize');
const fontVal  = document.getElementById('fontVal');
const stageSize= document.getElementById('stageSize');
const stageVal = document.getElementById('stageVal');
const realismSel = document.getElementById('realism');

const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const muteBtn  = document.getElementById('muteBtn');
const camStatus= document.getElementById('camStatus');
const webcamEl = document.getElementById('webcam');
const canvas   = document.getElementById('overlay');
const ctx      = canvas.getContext('2d');
const hud      = document.getElementById('hud');
const stageEl  = document.getElementById('stage');

const leftInstrument  = document.getElementById('leftInstrument');
const rightInstrument = document.getElementById('rightInstrument');
const scaleRoot = document.getElementById('scaleRoot');
const scaleType = document.getElementById('scaleType');
const volume = document.getElementById('volume');
const perfMode = document.getElementById('perfMode');
const mirrorSel = document.getElementById('mirror');
const drawSel   = document.getElementById('draw');

const recBtn = document.getElementById('recBtn');
const recStopBtn = document.getElementById('recStopBtn');
const recTimer = document.getElementById('recTimer');
const recDownload = document.getElementById('recDownload');

const compactBtn = document.getElementById('compactBtn');
const headerEl = document.querySelector('header');

const soundSetSel = document.getElementById('soundSetSel');

/* ============= Banco de sonidos ============= */
const SOUND_SETS = {
  electronico: ["(Sin instrumento)","Sintetizador","Piano","Guitarra","Viol√≠n","Brass","√ìrgano"],
  regional:    ["(Sin instrumento)","Acorde√≥n","Tuba","Trompeta","Vihuela","Bajo sexto"]
};
let soundSet = localStorage.getItem('soundSet') || 'electronico';
soundSetSel.value = soundSet;

function setInstrumentOptions(forSet){
  const arr = SOUND_SETS[forSet];
  const rebuild = (sel) => {
    const prev = sel.value;
    sel.innerHTML = arr.map(x=>`<option>${x}</option>`).join('');
    if (arr.includes(prev)) sel.value = prev;
  };
  rebuild(leftInstrument);
  rebuild(rightInstrument);
}
setInstrumentOptions(soundSet);
soundSetSel.addEventListener('change', ()=>{
  soundSet = soundSetSel.value;
  localStorage.setItem('soundSet', soundSet);
  setInstrumentOptions(soundSet);
  if (soundSet === 'regional'){ realismSel.value="1"; AudioEngine.setRealism(true); }
});

/* Tema / fuente / tama√±o escenario */
function applyTheme(v){ document.body.setAttribute('data-theme', v); localStorage.setItem('theme', v); }
function applyFont(pct){ document.documentElement.style.setProperty('--fs', (pct/100*15).toFixed(2)+'px'); fontVal.textContent = pct+'%'; localStorage.setItem('fs', pct); }
function applyStage(pct){ stageEl.style.height = (pct/100*520) + 'px'; stageVal.textContent = pct+'%'; localStorage.setItem('stage', pct); requestLayout(); }
themeSel.value = localStorage.getItem('theme') || 'system'; applyTheme(themeSel.value);
fontSize.value = localStorage.getItem('fs') || '100'; applyFont(+fontSize.value);
stageSize.value= localStorage.getItem('stage') || '100'; applyStage(+stageSize.value);
themeSel.addEventListener('change', e=> applyTheme(e.target.value));
fontSize.addEventListener('input', e=> applyFont(+e.target.value));
stageSize.addEventListener('input', e=> applyStage(+e.target.value));

/* ====== Estado global ====== */
let vision, handLandmarker, faceLandmarker;
let running = false;
let stream = null;
let drawLandmarks = true;

/* ================== Audio + Grabaci√≥n ================== */
const AudioEngine = (() => {
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC({ latencyHint: 'interactive' });

  // Buses
  const master = ctx.createGain(); master.gain.value = 0.85;
  const root   = ctx.createGain();
  const dry    = ctx.createGain(); dry.gain.value = 1.0; root.connect(dry);
  const convolver = ctx.createConvolver(); // IR sint√©tica
  const wet    = ctx.createGain(); wet.gain.value = 0.0;
  root.connect(convolver); convolver.connect(wet);
  dry.connect(master); wet.connect(master); master.connect(ctx.destination);

  // Grabaci√≥n
  const recorderDest = ctx.createMediaStreamDestination();
  master.connect(recorderDest);
  let mediaRecorder = null, chunks = [], recStartTs = 0, recTimerId = null;

  function makeImpulseResponse(seconds=0.35, decay=3.5){
    const len = Math.max(1, Math.floor(seconds * ctx.sampleRate));
    const buf = ctx.createBuffer(2, len, ctx.sampleRate);
    for(let ch=0; ch<2; ch++){
      const d = buf.getChannelData(ch);
      for(let i=0;i<len;i++){
        const t = i/len;
        d[i] = (Math.random()*2-1) * Math.pow(1-t, decay);
      }
    }
    return buf;
  }
  convolver.buffer = makeImpulseResponse();
  function setRealism(on){ wet.gain.linearRampToValueAtTime(on ? 0.28 : 0.0, ctx.currentTime+0.05); }

  // Utilidades musicales
  const noteFreq = (note) => {
    const A4 = 440;
    const map = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};
    const m = note.match(/^([A-G]#?|Bb|Db|Gb)(\d)$/); const n = map[m[1]]; const o = +m[2];
    return A4 * Math.pow(2, (n - 9 + (o - 4)*12)/12);
  };
  const buildScale = (root="C4", type="major")=>{
    const iv={major:[0,2,4,5,7,9,11,12],minor:[0,2,3,5,7,8,10,12],pentatonic:[0,2,4,7,9,12],blues:[0,3,5,6,7,10,12]}[type]||[0,2,4,5,7,9,11,12];
    const baseTable={'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11,'Bb':10,'Db':1,'Gb':6,'Ab':8,'Eb':3};
    const mm=root.match(/^([A-G]#?|Bb|Db|Gb)(\d)$/); const base=baseTable[mm[1]]; const octave=+mm[2];
    const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    return iv.map(semi=>{const total=base+semi+octave*12; return `${names[(total%12+12)%12]}${Math.floor(total/12)}`;});
  };

  const makeLFO=(freq=5,destParam,depth=10,type='sine')=>{
    const lfo=ctx.createOscillator(); lfo.type=type; lfo.frequency.value=freq;
    const g=ctx.createGain(); g.gain.value=depth; lfo.connect(g); g.connect(destParam); lfo.start(); return {lfo,g};
  };

  // Karplus‚ÄìStrong pluck voice (vihuela/bajo sexto)
  function createPluckVoice(dest=root){
    const g = ctx.createGain(); g.gain.value = 0; g.connect(dest);
    const delay = ctx.createDelay(1.0);
    const fb = ctx.createGain(); fb.gain.value = 0.965;
    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=4500;
    delay.connect(lp).connect(fb).connect(delay);
    const startGain = ctx.createGain(); startGain.connect(delay);
    delay.connect(g);
    function excite(){
      const b = ctx.createBuffer(1, 2048, ctx.sampleRate);
      const d = b.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i] = Math.random()*2-1;
      const src = ctx.createBufferSource(); src.buffer=b; src.connect(startGain); src.start();
    }
    return {
      setFreq(f){ const period = 1/Math.max(40, f); delay.delayTime.setTargetAtTime(period, ctx.currentTime, 0.002); lp.frequency.setTargetAtTime(1800 + f*2, ctx.currentTime, 0.01); },
      strike(velo=1){ g.gain.cancelScheduledValues(ctx.currentTime); g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(Math.min(0.9, 0.4+0.5*velo), ctx.currentTime+0.003); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.85); excite(); },
      release(){ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.1); }
    };
  }

  function addFormants(o, freqsQ){
    const biqs = freqsQ.map(([f,q])=>{ const b = ctx.createBiquadFilter(); b.type='bandpass'; b.frequency.value=f; b.Q.value=q; return b; });
    o.mix.disconnect(); let head = o.mix;
    biqs.forEach(b=>{ head.connect(b); head=b; });
    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=8000; head.connect(lp); lp.connect(o.gain); o.filter = lp;
  }

  function applyPreset(name,o){
    if (name==="Sintetizador"){ o.osc.type='sawtooth'; o.osc2.type='square'; o.filter.frequency.value=12000; }
    else if (name==="Piano"){ o.osc.type='triangle'; o.osc2.type='square'; o.filter.frequency.value=6000; }
    else if (name==="Guitarra"){ o.osc.type='sawtooth'; o.osc2.type='sawtooth'; o.filter.frequency.value=4200; }
    else if (name==="Viol√≠n"){ o.osc.type='sawtooth'; o.osc2.type='sawtooth'; o.filter.frequency.value=8000; }
    else if (name==="Brass"){ o.osc.type='square'; o.osc2.type='square'; o.filter.frequency.value=5000; }
    else if (name==="√ìrgano"){ o.osc.type='square'; o.osc2.type='triangle'; o.filter.frequency.value=10000; }
    else if (name==="Acorde√≥n"){ o.osc.type='sawtooth'; o.osc2.type='sawtooth'; o.osc.detune.value=-8; o.osc2.detune.value=+8; addFormants(o, [[450,2.0],[900,1.5],[1800,1.2]]); o.lfo=makeLFO(5,o.gain.gain,0.05,'sine'); }
    else if (name==="Tuba"){ o.osc.type='sine'; o.osc2.type='square'; addFormants(o, [[220,3.0],[440,2.0],[700,1.2]]); o.envShape={a:0.02,d:0.18,s:0.85}; }
    else if (name==="Trompeta"){ o.osc.type='square'; o.osc2.type='sawtooth'; addFormants(o, [[900,3.0],[1500,2.0],[2400,1.4]]); o.pitchEnv=true; }
  }

  const createVoice=(instrument="Sintetizador",dest=root)=>{
    if (instrument==="Vihuela" || instrument==="Bajo sexto"){
      const pv = createPluckVoice(dest);
      return { gain:{gain:{value:0}}, strike:(freq, velo)=>{ pv.setFreq(freq); pv.strike(velo); }, release:()=>pv.release() };
    }
    const o={};
    o.gain=ctx.createGain(); o.gain.gain.value=0; o.gain.connect(dest);
    o.filter=ctx.createBiquadFilter(); o.filter.type='lowpass'; o.filter.frequency.value=12000; o.filter.Q.value=0.7; o.filter.connect(o.gain);
    o.osc=ctx.createOscillator(); o.osc2=ctx.createOscillator(); o.osc.frequency.value=220; o.osc2.frequency.value=220; o.osc.start(); o.osc2.start();
    o.mix=ctx.createGain(); o.mix.gain.value=.72; o.osc.connect(o.mix); o.osc2.connect(o.mix); o.mix.connect(o.filter);
    const buf=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate); const data=buf.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
    const noise=ctx.createBufferSource(); noise.buffer=buf; noise.loop=true; noise.start();
    o.noiseGain=ctx.createGain(); o.noiseGain.gain.value=0; noise.connect(o.noiseGain); o.noiseGain.connect(o.filter);
    applyPreset(instrument,o);

    o.setFreq=(f)=>{
      const now=ctx.currentTime;
      if(o.pitchEnv){
        o.osc.frequency.setValueAtTime(f*1.03, now); o.osc2.frequency.setValueAtTime(f*1.03, now);
        o.osc.frequency.exponentialRampToValueAtTime(Math.max(20,f), now+0.05);
        o.osc2.frequency.exponentialRampToValueAtTime(Math.max(20,f), now+0.05);
      }else{
        o.osc.frequency.exponentialRampToValueAtTime(Math.max(20,f), now+0.01);
        o.osc2.frequency.exponentialRampToValueAtTime(Math.max(20,f*0.999), now+0.01);
      }
    };
    o.env=(target=0.65,a=0.008,d=0.06,s=0.55)=>{
      if(o.envShape){ a=o.envShape.a; d=o.envShape.d; s=o.envShape.s; }
      const now=ctx.currentTime;
      o.gain.gain.cancelScheduledValues(now);
      o.gain.gain.linearRampToValueAtTime(target, now+a);
      o.gain.gain.linearRampToValueAtTime(target*s, now+a+d);
    };
    o.release=(r=0.12)=>{ const now=ctx.currentTime; o.gain.gain.cancelScheduledValues(now); o.gain.gain.setTargetAtTime(0, now, r); };
    o.strike=(tone=440, velo=1)=>{
      o.setFreq(tone);
      o.noiseGain.gain.setValueAtTime(0.06*velo, ctx.currentTime);
      o.noiseGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.06);
      o.env(Math.min(0.8,0.35+0.5*velo), 0.004, 0.05, 0.6);
    };
    return o;
  };

  const drums=(()=>{
    const kick=(vel=1)=>{
      const osc=ctx.createOscillator(); osc.type='sine';
      const g=ctx.createGain(); g.gain.value=0.0001;
      const f0=(soundSet==='regional')?90:120, f1=(soundSet==='regional')?38:45;
      osc.frequency.setValueAtTime(f0, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(f1, ctx.currentTime+0.18);
      g.gain.setValueAtTime(0.95*vel, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.22);
      osc.connect(g); g.connect(root); osc.start(); osc.stop(ctx.currentTime+0.25);
    };
    const snare=(vel=1)=>{
      const nb=ctx.createBuffer(1, ctx.sampleRate*0.6, ctx.sampleRate), d=nb.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
      const noise=ctx.createBufferSource(); noise.buffer=nb;
      const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=(soundSet==='regional')?1800:2500; bp.Q.value=(soundSet==='regional')?0.7:0.5;
      const g=ctx.createGain(); g.gain.value=(soundSet==='regional')?1.0*vel:0.9*vel;
      noise.connect(bp); bp.connect(g); g.connect(root);
      noise.start(); const dur=(soundSet==='regional')?0.22:0.18;
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur); noise.stop(ctx.currentTime+dur+0.02);
    };
    const hihat=(open=false, vel=1)=>{
      const nb=ctx.createBuffer(1, ctx.sampleRate*0.5, ctx.sampleRate), d=nb.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
      const noise=ctx.createBufferSource(); noise.buffer=nb;
      const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=(soundSet==='regional')?8000:7000; hp.Q.value=0.8;
      const g=ctx.createGain(); g.gain.value=(soundSet==='regional')?0.7*vel:0.6*vel;
      noise.connect(hp); hp.connect(g); g.connect(root);
      noise.start(); const dur=open?((soundSet==='regional')?0.42:0.35):0.08;
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur); noise.stop(ctx.currentTime+dur+0.02);
    };
    const crash=(vel=1)=>{
      const nb=ctx.createBuffer(1, ctx.sampleRate*1.5, ctx.sampleRate), d=nb.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
      const noise=ctx.createBufferSource(); noise.buffer=nb;
      const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=5200; bp.Q.value=0.35;
      const g=ctx.createGain(); g.gain.value=0.55*vel;
      noise.connect(bp); bp.connect(g); g.connect(root);
      noise.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.9); noise.stop(ctx.currentTime+0.95);
    };
    return {kick,snare,hihat,crash};
  })();

  // Grabaci√≥n
  function startRecording(){
    chunks = [];
    const stream = recorderDest.stream;
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
    mediaRecorder = new MediaRecorder(stream, { mimeType: mime, audioBitsPerSecond: 192000 });
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
      const url = URL.createObjectURL(blob);
      recDownload.href = url;
      recDownload.style.display = 'inline';
    };
    mediaRecorder.start();
    recStartTs = Date.now();
    recTimerId = setInterval(()=>{
      const s = Math.floor((Date.now()-recStartTs)/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      recTimer.textContent = `${mm}:${ss}`;
    }, 200);
  }
  function stopRecording(){
    if(mediaRecorder && mediaRecorder.state !== 'inactive'){
      mediaRecorder.stop();
      clearInterval(recTimerId);
      recTimerId = null;
    }
  }

  return {
    ctx, master,
    setVolume(v){ master.gain.value = v; },
    buildScale, noteFreq,
    createVoice, drums,
    startRecording, stopRecording,
    setRealism
  };
})();

/* ======== M√∫sica / asignaciones ======== */
let scale = AudioEngine.buildScale("C4","major");
const fingerToDegree = { thumb:0, index:1, middle:2, ring:3, pinky:4 };
const fingerList = ["thumb","index","middle","ring","pinky"]; // <‚Äî una sola vez

function degreeToFreq(deg, bias=0){
  const idx=Math.min(scale.length-1, Math.max(0,deg));
  const note=scale[idx];
  return AudioEngine.noteFreq(note) * Math.pow(2, bias/12);
}
function updateScale(){ scale = AudioEngine.buildScale(scaleRoot.value, scaleType.value); }
scaleRoot.addEventListener('change', updateScale);
scaleType.addEventListener('change', updateScale);
volume.addEventListener('input', e=> AudioEngine.setVolume(parseFloat(e.target.value)));

/* ======= Dibujo landmarks ======= */
drawLandmarks = (drawSel.value==="1");
drawSel.addEventListener('change', e=> drawLandmarks = e.target.value==="1");
const drawUtils = new DrawingUtils(ctx);
function drawHands(res){
  if(!drawLandmarks) return;
  ctx.save();
  res?.landmarks?.forEach((lm)=>{
    drawUtils.drawConnectors(lm, HandLandmarker.HAND_CONNECTIONS,{color:"#5dd6ff"});
    drawUtils.drawLandmarks(lm, {color:"#44d19f", radius:2.2});
  });
  ctx.restore();
}
function drawFace(res){
  if(!drawLandmarks) return;
  ctx.save();
  res?.faceLandmarks?.forEach(lm=>{
    drawUtils.drawLandmarks(lm, {color:"#ffc857", radius:1.8});
  });
  ctx.restore();
}

/* ===== Utilidades manos ===== */
function isFingerExtended(landmarks, finger, HK){
  const idx = { thumb:[1,2,3,4], index:[5,6,7,8], middle:[9,10,11,12], ring:[13,14,15,16], pinky:[17,18,19,20] }[finger];
  const [mcp, pip, , tip] = idx.map(i=> landmarks[i]);
  if(finger === "thumb"){
    return (HK==="R") ? (tip.x > mcp.x + 0.06) : (tip.x < mcp.x - 0.06);
  }else{
    return (pip.y - tip.y) > 0.035;
  }
}
function wristGain(landmarks){ const w=landmarks[0]; return Math.min(1, Math.max(0, 1 - w.y)); }
function lerp(a,b,t){ return a + (b-a)*t; }

/* ===== Voces por dedo/mano ===== */
const activeVoices = {};
function ensureVoice(key, instrument){
  if(!activeVoices[key]){
    activeVoices[key] = AudioEngine.createVoice(instrument);
  }
  return activeVoices[key];
}
function stopVoice(key){ if(activeVoices[key]) activeVoices[key].release(); }

/* ===== Cara ‚Üí Percusi√≥n (sin lengua) ===== */
const faceState = { blinkL:false, blinkR:false, mouth:false };
function getBlendmap(blendshapes){ const map={}; blendshapes?.categories?.forEach(c=>map[c.categoryName]=c.score); return map; }
function edge(prev, now, th=0.55){ return (!prev && now>th); }
function processFace(result){
  if(!result) return;
  const bm = getBlendmap(result.faceBlendshapes?.[0] || {});
  const blinkL  = bm["eyeBlinkLeft"]  ?? 0;
  const blinkR  = bm["eyeBlinkRight"] ?? 0;
  const mouthOpen = (bm["mouthOpen"] ?? 0) + (bm["jawOpen"] ?? 0)*0.5;

  if(edge(faceState.blinkL, blinkL)) AudioEngine.drums.hihat(false, 0.9);
  if(edge(faceState.blinkR, blinkR)) AudioEngine.drums.hihat(true, 0.9);
  if(edge(faceState.mouth, mouthOpen, 0.6)) AudioEngine.drums.snare(1.0);
  if( (blinkL>0.6 && blinkR>0.6) && !(faceState.blinkL && faceState.blinkR) ){ AudioEngine.drums.kick(1.0); }

  faceState.blinkL = blinkL>0.55; faceState.blinkR = blinkR>0.55; faceState.mouth = mouthOpen>0.6;
  hud.innerHTML = `
    <span class="pill">${(blinkL>0.55?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è')} L</span>
    <span class="pill">${(blinkR>0.55?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è')} R</span>
    <span class="pill">${(mouthOpen>0.6?'üó£Ô∏è BOCA':'üôÇ')}</span>`;
}

/* ===== Bucle de inferencia ===== */
let lastInfer = 0;
const SPEEDS = { speed:1/45, balanced:1/30, quality:1/20 };
async function loop(){
  if(!running) return;
  const now=performance.now()/1000, minDelta=SPEEDS[perfMode.value]||SPEEDS.balanced;
  if(now - lastInfer >= minDelta){
    lastInfer = now;
    const ts = performance.now();
    const hands = await handLandmarker.detectForVideo(webcamEl, ts);
    const face  = await faceLandmarker.detectForVideo(webcamEl, ts);
    ctx.clearRect(0,0,canvas.width, canvas.height);
    if(drawLandmarks){ drawHands(hands); drawFace(face); }
    processHands(hands); processFace(face);
  }
  requestAnimationFrame(loop);
}

/* ===== Manos ‚Üí Notas ===== */
const smoothY = {};
function processHands(result){
  if(!result) return;
  for(let i=0;i<result.handedness.length;i++){
    const handed = result.handedness[i][0].categoryName; 
    const HK = handed.toLowerCase().startsWith("left")?"L":"R";
    const selected = HK==="L" ? leftInstrument.value : rightInstrument.value;
    const noInstrument = (selected === "(Sin instrumento)");
    const lm = result.landmarks[i]; const g = wristGain(lm);

    for(const finger of fingerList){
      const key=`${HK}_${finger}`;
      const deg=fingerToDegree[finger];
      const tipIndex={thumb:4,index:8,middle:12,ring:16,pinky:20}[finger];
      const tip=lm[tipIndex]; const idKey=`${key}_tip`;
      const sy = smoothY[idKey] = lerp(smoothY[idKey] ?? tip.y, tip.y, 0.35);
      const pitchBias = Math.round((0.5 - sy) * 24);
      const freq = degreeToFreq(deg, pitchBias);
      const extended = isFingerExtended(lm, finger, HK);

      if(noInstrument || !extended){
        stopVoice(key);
      }else{
        const v = ensureVoice(key, selected);
        v.strike(freq, Math.max(0.2, g));
        if(v.gain?.gain) v.gain.gain.value = Math.min(0.9, (0.25 + 0.7*g));
      }
    }
  }
}

/* ======= Layout (cover + HiDPI + espejo) ======= */
const dpr = Math.max(1, window.devicePixelRatio || 1);
function requestLayout(){
  const stageRect = stageEl.getBoundingClientRect();
  const stageW = stageRect.width, stageH = stageRect.height;
  const vidW = webcamEl.videoWidth || 1280;
  const vidH = webcamEl.videoHeight || 720;

  const scale = Math.max(stageW/vidW, stageH/vidH);
  const drawW = vidW * scale;
  const drawH = vidH * scale;
  const offsetX = (stageW - drawW) / 2;
  const offsetY = (stageH - drawH) / 2;

  canvas.style.width  = drawW + 'px';
  canvas.style.height = drawH + 'px';
  canvas.style.left   = offsetX + 'px';
  canvas.style.top    = offsetY + 'px';

  canvas.width  = Math.round(drawW * dpr);
  canvas.height = Math.round(drawH * dpr);

  if (mirrorSel.value === "1") ctx.setTransform(-dpr, 0, 0, dpr, canvas.width, 0);
  else                         ctx.setTransform( dpr, 0, 0, dpr, 0, 0);
}
const ro = new ResizeObserver(()=> requestLayout());
ro.observe(stageEl);
window.addEventListener('resize', requestLayout);

/* ===== C√°mara / modelos ===== */
async function setupCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video: { width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:60, max:60} }, audio:false
  });
  webcamEl.srcObject = stream;
  await webcamEl.play();
  requestLayout();
}
async function loadModels(){
  const wasmBase = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm";
  const fileset = await FilesetResolver.forVisionTasks(wasmBase);
  handLandmarker = await HandLandmarker.createFromOptions(fileset, {
    baseOptions: { modelAssetPath: HAND_MODEL_URL }, numHands:2, runningMode:"VIDEO"
  });
  faceLandmarker = await FaceLandmarker.createFromOptions(fileset, {
    baseOptions: { modelAssetPath: FACE_MODEL_URL }, runningMode:"VIDEO",
    numFaces:1, outputFaceBlendshapes:true, outputFacialTransformationMatrices:false
  });
}

/* ===== Controles ===== */
startBtn.addEventListener('click', async ()=>{
  startBtn.disabled = true;
  try{
    await AudioEngine.ctx.resume();
    AudioEngine.setVolume(parseFloat(volume.value));
    await setupCamera(); await loadModels();
    camStatus.className = "status-dot ok";
    running = true; stopBtn.disabled = false;
    recBtn.disabled = false; recDownload.style.display='none'; recTimer.textContent='00:00';
    loop();
  }catch(err){
    console.error(err); camStatus.className = "status-dot err";
    envHint.textContent = "Error al iniciar: " + (err?.message || err);
    startBtn.disabled = false;
  }
});
stopBtn.addEventListener('click', ()=>{
  running=false; stopBtn.disabled=true; startBtn.disabled=false; camStatus.className="status-dot warn";
  recBtn.disabled = true; recStopBtn.disabled = true;
  Object.keys(activeVoices).forEach(k=> stopVoice(k));
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
});

muteBtn.addEventListener('click', ()=>{ AudioEngine.setVolume(0); volume.value=0; });
volume.addEventListener('change', ()=> AudioEngine.setVolume(parseFloat(volume.value)) );

recBtn.addEventListener('click', ()=>{
  recBtn.disabled = true; recStopBtn.disabled = false; recDownload.style.display='none'; recTimer.textContent='00:00';
  AudioEngine.startRecording();
});
recStopBtn.addEventListener('click', ()=>{
  recStopBtn.disabled = true; recBtn.disabled = false;
  AudioEngine.stopRecording();
});

drawSel.addEventListener('change', ()=>{ drawLandmarks = (drawSel.value==="1"); });
mirrorSel.addEventListener('change', ()=> requestLayout());
realismSel.addEventListener('change', e=> AudioEngine.setRealism(e.target.value === "1"));

compactBtn.addEventListener('click', ()=>{
  const compact = !headerEl.classList.contains('compact');
  headerEl.classList.toggle('compact', compact);
  compactBtn.textContent = compact ? 'Expandir barra' : 'Compactar barra';
});
</script>
</body>
</html>
